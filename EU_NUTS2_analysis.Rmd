---
title: "EU regional models"
author: "Bodo Balazs, Daniel Antal, CFA"
date: "04/05/2020"
output:
  pdf_document: default
  html_document: default
  word_document: default
bibliography:
- packages.bib
- eurostat_bibliography.bib
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # includes dplyr, tidyr and ggplot2
library(sf)        # for the map plotting
library(randomForest); library(caret) # for random forest
library(iml)  # better interpretation of random forest results
library(sjPlot); library(sjmisc)  # interaction in regression
library(MASS)
library(jtools)
library(huxtable)
library (car)
require(caret); require(randomForest)
library(satellitereport)
library(colorRamps)

#code to visualize data on the map
#devtools::install_github("antaldaniel/satellitereport")
#satellitereport::create_choropleth()

# data is compiled elsewhere. 
#uncomment the next line if you want to rerun data prepararion
#source("helper_code/prepare_data.R")
load(file.path("data", "all_data_for_analysis.rda"))

#correlation panel display function
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y)
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt)
}
```

# Introduction

The following document contains the analysis of illegal library downloads on an European NUTS2 regional level. We used EUROSTAT and EUROBAROMETER data sources to compile two data sets. The dataset which only contains 17 explanatory variables data from the EUROSTAT database covers 265 NUTS2 regions, 7 versions of the explained variable, 17 explanatory variables, and one metadata variable (the regional code.) The second dataset, which also includes six additional variables  from the  EUROBAROMETER database covers 217 NUTS2 regions. We describe the  dataset used in the  analysis in a separate document in this repository. 

## The complete cases for the eurostat dataset
The map below shows the total number of downloads per region, and the completeness of that dataset.

```{r completemap, echo=FALSE}
eurostat_complete_data %>%
  dplyr::mutate ( time = 2013 ) %>%
  dplyr::select ( geo, count, time ) %>%
  dplyr::rename ( values = count ) %>%
  satellitereport::create_choropleth(., level = 2, n = 7, 
                                     style = 'pretty', 
                                     na_color = 'blue',
                                     color_palette= colorRamps::green2red(7))
```

## The complete cases for the eurostat+eurobarometer dataset
The map below shows the total number of downloads per region, and the completeness of the second, richer, but smaller dataset.

```{r completemap eurobarometer, echo=FALSE}
eurostat_eurobarometer_complete_data %>%
  dplyr::mutate ( time = 2013 ) %>%
  dplyr::select ( geo, count, time ) %>%
  dplyr::rename ( values = count ) %>%
  satellitereport::create_choropleth(., level = 2, n = 7, 
                                     style = 'pretty', 
                                     na_color = 'blue',
                                     color_palette= colorRamps::green2red(7))
```

# Analysis

## Descriptives, and general concerns

The median number of downloads is 10k, the mean is higher, 18648. With some extreme outliers.

```{r count descriptives}
summary(eurostat_complete_data$count)
histogram(log10(eurostat_complete_data$count), 
          nint=100, 
          type="count")
boxplot(eurostat_complete_data$count)
```

Some of the other regions (see the maps above) are as expected, big, metropolitan regions, such as inner London, with large populations, and a strong concentration of knowledge-intensive activities. There are, however, exceptions to this rule, where regions without significant urban centers, or educational, research capacities demonstrate unusually high download volumes. We identified a number of possible reasons for these anomalies:

* there might be issues with the translation of IP addresses to geolocation. We used the MaxMind service to assign coordinates to IP addresses, and the accuracy of the service, may vary for different countries, or internet service providers. In this latter case, it is possible that lacking better information, whole IP ranges resolve to, for example, the HQ address of the provider, rather than to the approximate location of the user. This is a well-known issue in general, and a potential source of noise in our case as well.

* We did our best to identify Virtual Private Networks, TOR exit nodes, and other traffic sources, which may mask the true location of the downloader. However, such information may not always be available, therefore it is possible that we failed to identify traffic sources as VPNs. In such cases, we incorrectly associate substantial foreign traffic with a particular geographic location. 

* Last, but not least, though we tried our best to identify bots and other automated traffic sources in the dataset. For example, we filtered repeated downloads from the same IP of the same book within a given time-window. However, it is possible that we did not identified all the automatic scraping, which does not represent human downloaders. In other parts of the dataset we have evidence for such automated, scraper-generated traffic, and on smaller scale, this might also produce unexpected outliers in the European dataset.

That being said, if we look at the degrees of correlation between or ultimate dependent variable, the number of downloads in a region, and other variables, we see strong correlations, especially with wealth (measured by GDP), the number of researchers, population, and knowledge intensive economic activities.

```{r correlation, echo=FALSE }
correlations <- eurostat_complete_data %>%
  dplyr::select( -starts_with("count_")) %>%
  dplyr::select ( -geo ) %>% 
  as.matrix() %>%
  cor() 

correlations [, "count"]  %>% 
  as.data.frame() %>%
  rownames_to_column() %>%
  purrr::set_names ( ., c("variable", "cor")) %>%
  dplyr::filter ( ! grepl( "count", variable )) %>% 
  dplyr::mutate ( variable = forcats::fct_reorder(variable, -cor )) %>%
  ggplot (., aes ( x = variable, 
                   y = cor, 
                   fill = cor )) +
  geom_col(  ) +
  scale_fill_gradient2( high = "#007CBB", 
                        mid = 'white', 
                        low = "#DB001C", 
                        midpoint = 0) +
  labs ( title = "Correlation with Count Data", 
         fill = 'Correlation', y = "", x = "") +
  theme (
    axis.text.x = element_text (angle = 30, hjust = 1, size = rel(0.85))
  )
```

## Spatial auto-correlation 

As a first step in the analysis, we consider the spatial distribution of the data. If the spatial geography of the environment is relevant to the data, then we should see a level autocorrelation by nearer territorial units. We have examined the spatial autocorrelation using the `spdep` package of Bivand, Pebesma and Gomez-Rubio [@spdep2013].

```{r mcmoran, echo=FALSE, eval=TRUE}
#we use the full download dataset, rather than the one complete with EUROSTAT data, so we can include all European NUTS2 regions for his abalysis 
download_data <- readRDS( file.path("data-raw","downloads_nuts_2016.rds")) 

moran_analysis_spdf <-  geodata@data %>%
  dplyr::left_join (.,  
  download_data %>%
     dplyr::select ( id, count ) %>%
     dplyr::mutate ( count = ifelse (is.na(count), 0, count)),
  by = 'id' )

moran_i_spdf <-  geodata@data %>%
  dplyr::left_join (.,  
  download_data %>%
     dplyr::select ( id, count ),  by = 'id' ) %>%
     dplyr::filter  ( !is.na(count )) 


moran_analysis_spdf_gdp_pps <-  geodata@data %>%
  dplyr::left_join (.,  
             eurostat_data %>%
               dplyr::select ( geo, gdp_pps ) %>%
               dplyr::mutate ( id = geo),
             by = 'id' ) %>%
     dplyr::filter  ( !is.na(gdp_pps)) 


#summary ( moran_i_spdf$count )
#summary ( moran_analysis_spdf_gdp_pps$gdp_pps )

geodata_full   <- geodata [which ( moran_i_spdf$id %in% geodata@data$id), ]
geodata_gdp_full <- geodata [which ( moran_analysis_spdf_gdp_pps$id %in% geodata@data$id), ]

w <- spdep::poly2nb(geodata_full, row.names=geodata_full$id )
w_gdp <- spdep::poly2nb(geodata_gdp_full, row.names=geodata_gdp_full$id )
#neighbor lists
ww <- spdep::nb2listw(w, style='B', zero.policy=TRUE)
ww2 <- spdep::nb2listw(w_gdp, style='B', zero.policy=TRUE)


set.seed(2019)
moran_count_results <- spdep::moran.mc(
                x = moran_i_spdf %>%
                  dplyr::select ( count ) %>% 
                  unlist () %>%
                  as.numeric(),       
                ww, 
                nsim=999,
                zero.policy = TRUE)

set.seed(2019)

moran_gdp_results <- spdep::moran.mc(
               x = moran_analysis_spdf_gdp_pps %>%
                  dplyr::select ( gdp_pps ) %>% 
                  unlist () %>%
                  as.numeric(),       
                ww2, 
                nsim=999,
                zero.policy = TRUE)

```


Moran's I statistic takes the value of 0.042 with a p-value of 0.094, so we can only reject the randomness of downloads at a 90% significance level. The positive z value means that the downloads are clustering, i.e. NUTS2 regions with high download numbers tend to be neighbors of NUTS2 regions with high download numbers.  


```{r moran_count, echo=FALSE}
moran_count_results
```

Similarly, running the same test for GDP adjusted by purchasing power standard, we see a very similar level of spatial autocorrelation.

```{r moran_gdp, echo=FALSE}
moran_gdp_results
```


# Interaction with environmental variables

Next, we pursued the following modeling approach:

* First, we tried to test on the European dataset, the same hypothesis that we tested on the global data, namely that lower income regions compensate their infrastructural shortcomings by the more extensive use of piratical resources. We control for wealth, and knowledge intensive macro-economic variables, such as R7D sending, or the share of researchers in the active population. This would be a limited model in terms of independent variables, but which, in return,  would allow us to include the most NUTS2 regions in the analysis.

* Second, we used alternative modeling techniques, such as random forest methods, to check if we could find additional variables which we could be included in our models. In this step we run this analysis on the narrower, but more larger EUROSTAT dataset.

* Third, we add the EUROBAROMETER variables, at the expense of reducing somewhat the size of the dataset, and use the random forest approach to identify if there are important new explanatory variables among the newly added ones.

* Lastly, we re-run any liner regression models if the random forest identified new variables.


In each of these steps we test the models for three dependent variables: (1) the raw download count, (2) the download count normalized by the population, and (3) the download count normalized by the number of researchers. To be able to use Poisson and quasipoisson models we normalized the count variables per million inhabitants or researchers, and rounded the results.


## Hypothesis testing through simple linear regressions

```{r percapita_scatterplot, echo=FALSE}
#first lets see how in the best model data anbd correlations look like

cpc_correlations_bestmodel <- eurostat_complete_data %>%
  dplyr::select (count_per_capita, 
                 gdp_pps_hab, 
                 researcher_employment_pct,
                 disposable_income,
                 edu_attainment_total,
                 hr_scitech_pct,
                 internet_use_banking_pc,
                 internet_use_social_networks_pc,
                 internet_use_daily_pc,
                 gerd) %>%
      dplyr::mutate_if( is.numeric, as.numeric)%>%
  as.matrix() %>%
  pairs(lower.panel = panel.smooth,
        upper.panel = panel.cor,
      gap=0, 
      row1attop=FALSE, 
      main="Correlation coefficients on the upper panels, scatter plots in the lower panels with LOESS smooths")



```

### per capital download models


``` {r percapita_linear models, echo=TRUE, out.width='90%'}
## Poisson with scitech hr
percapita_plm1 <- glm (count_per_million ~ 
                 gdp_pps_hab +
                 researcher_employment_pct +
                 disposable_income +
                 edu_attainment_total +
                 hr_scitech_pct +  
                 internet_use_banking_pc, 
                 data = eurostat_complete_data, 
                 family = poisson )

## Poisson withoutr scitech hr
percapita_plm2 <- glm (count_per_million ~ 
                         gdp_pps_hab +  
                         researcher_employment_pct +
                         disposable_income +
                         edu_attainment_total +
                         internet_use_banking_pc,
                       data = eurostat_complete_data, 
                       family = poisson )

## Switch to log(gdp_pps)

percapita_plm3 <- glm (count_per_million ~ 
                         log(gdp_pps) +  
                         researcher_employment_pct +
                         disposable_income +
                         edu_attainment_total +
                         internet_use_banking_pc,
                       data = eurostat_complete_data, 
                       family = poisson )

#quasipoisson

percapita_qplm3 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                          internet_use_banking_pc,
                        data = eurostat_complete_data,
                        family = quasipoisson)

## Try online shopping instead of banking
percapita_qplm4 <- glm (count_per_million ~ 
                          log(gdp_pps) +  
                          researcher_employment_pct +
                          internet_purchases_last_year_pc,
                        data = eurostat_complete_data, 
                        family = quasipoisson)

##try disposable income and edu level
percapita_qplm5 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                          internet_use_banking_pc +
                          log(disposable_income) , 
                        
                        data =eurostat_complete_data, 
                        family = quasipoisson)

percapita_qplm6 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                          internet_use_banking_pc +
                          gerd, 
                        
                        data =eurostat_complete_data, 
                        family = quasipoisson)

percapita_qplm7 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          internet_use_banking_pc +
                          gerd, 
                        
                        data =eurostat_complete_data, 
                        family = quasipoisson)
vif(percapita_qplm7)

#summary(percapita_plm3)
#summary(percapita_qplm3)

export_summs(percapita_qplm3, percapita_qplm4, percapita_qplm5, percapita_qplm6,percapita_qplm7,
             digits=3, 
             statistics = c("null.deviance", "deviance")
             )

summary (percapita_qplm3)  
library(rsq)
rsq(percapita_qplm3)
```

We first developed a number of models with download per million as the dependent variable. We found that adding the sci-tech employment variable causes serious multicollinearity issues, so we decided to drop it. We also switched  gdp_pps_hab to the logarithmic form of GDP_pps because it also created multicollinearity issues. We report here only the results of four quasipoission models. 

The  models offer the following findings:

* gdp is has a significant positive effect on the per capita downloads. wealthier regions download more. 

* the per capita downloads grow with higher percentages of researchers in the labor pool. Researchers are a primary source of download traffic

* higher disposable income also leads to higher download activity. 

These three effects point to different forms of structural demand effect. Economic activity, research activity drives demand for scientific literature. The disposable income points to an individual demand effect:  higher disposable income does not lower piracy, but actually creates more demand.

- on the other hand, per capita downloads are moderated by better online skills. The negative effect of online banking use may point to a higher use of legal sources, such as online and offline purchases, but we should also consider that online proficiency provides the skills to hide the online traces of illegal activities via the use of VPNs and Tor browsing.


```{r percapita_predicted_vs_actual, echo=FALSE}
plot_model(percapita_qplm3,
           type = "pred")

plot(percapita_qplm3)
correlation::correlation(eurostat_complete_data)
```

### per researcher download models

``` {r perresearcher linear models, out.width='90%'}
## Including scitech
perresearcher_plm2 <- glm (count_per_thousand_researchers ~
                             gdp_pps_hab  +
                             disposable_income +
                             edu_attainment_total + gerd +
                             internet_use_banking_pc+hr_scitech_pct,
                           data = eurostat_complete_data, 
                           family = poisson )

## Excluding scitech
perresearcher_plm1 <- glm (count_per_thousand_researchers ~
                             log(gdp_pps)  +
                             log(disposable_income) +
                             edu_attainment_total + gerd +
                             internet_use_banking_pc,
                           data = eurostat_complete_data, 
                           family = poisson )

## Quasi-Poisson model
perresearcher_qplm1 <- glm (count_per_thousand_researchers ~ 
                              log(gdp_pps)  + log(disposable_income) + 
                              edu_attainment_total + gerd +
                              internet_use_banking_pc,
                            data = eurostat_complete_data, 
                            family = quasipoisson )

perresearcher_qplm2 <- glm (count_per_thousand_researchers ~ 
                              log(gdp_pps)  + log(disposable_income) + 
                              edu_attainment_total + gerd +
                              internet_purchases_last_year_pc,
                            data = eurostat_complete_data, 
                            family = quasipoisson )

perresearcher_qplm3 <- glm (count_per_thousand_researchers ~ 
                              log(gdp_pps)*gerd,
                            data = eurostat_complete_data, 
                            family = quasipoisson )

vif(perresearcher_qplm1)
summary(perresearcher_qplm1)
export_summs(perresearcher_qplm1, perresearcher_qplm2,perresearcher_qplm3, 
             digits=3, 
             statistics = c("null.deviance", "deviance")
             )
plot(perresearcher_qplm1)
```

since the VIF check points to a high multicollinearity with hr_scitech_pct, we remove that variable from the analysis.
Since the Poisson models shows high overdispersion, we run a quasipoisson model. there the effects of the GDP and disposable income become non-significant. 

These results point to similar conclusions. the the per researcher download volume:

- still grows with wealth, but 
- is moderated by the R&D expenditure, and internet proficiency.

Regions with more internet proficiency populations, and with higher R&D spending download less per researcher.

```{r plot perresearcher models}
plot_model(perresearcher_qplm1, type = "pred")
```

### Count Regression Models

``` {r count models, out.width='90%'}
#count without R&D
count_plm2 <- glm (count ~ log(gdp_pps) +  researcher_employment_pct +
                 disposable_income +
                 edu_attainment_total +
                 internet_use_banking_pc, 
                 data = eurostat_complete_data, poisson )

#with R&D
count_plm3 <- glm (count ~ log(gdp_pps) +  researcher_employment_pct +
                 disposable_income +
                 edu_attainment_total +
                 internet_use_banking_pc +
                  gerd
                , data = eurostat_complete_data, poisson )

count_plm4 <- glm (count ~ log(gdp_pps) +  
                    researcher_employment_pct +
                    disposable_income +
                    edu_attainment_total +
                    internet_use_banking_pc +
                    gerd+
                    internet_purchases_last_year_pc
                    , data = eurostat_complete_data, poisson )

vif(count_plm4)
summary (count_plm4)
summary (count_plm3)

#qpoisson
count_qplm2 <- glm (count ~ log(gdp_pps) +  researcher_employment_pct +
                 log(disposable_income) +
                 edu_attainment_total +
                 internet_use_banking_pc,
                 data = eurostat_complete_data, quasipoisson)

count_qplm3<- glm (count ~ log(gdp_pps) +  researcher_employment_pct +
                 log(disposable_income) +
                 edu_attainment_total +
                 internet_use_banking_pc +
                gerd,
                data = eurostat_complete_data, quasipoisson )

#is there multicollinearity? yes.
vif(count_qplm3)

count_qplm3a<- glm (count ~ log(gdp_pps) +  
                 log(disposable_income) +
                 edu_attainment_total +
                 internet_use_banking_pc +
                gerd,
                data = eurostat_complete_data, quasipoisson )

count_qplm3b<- glm (count ~ log(gdp_pps) +  
                 log(disposable_income) +
                 internet_use_banking_pc +
                gerd,
                data = eurostat_complete_data, quasipoisson )

# is gerd sinificant if we remove researcher pct? no. education attainment?
summary(count_qplm3a)


count_qplm4 <- glm (count ~ log(gdp_pps) +  
                    researcher_employment_pct +
                    log(disposable_income) +
                    edu_attainment_total +
                    gerd +
                    internet_purchases_last_year_pc,
                    data = eurostat_complete_data, quasipoisson )

export_summs(count_qplm2,count_qplm3,count_qplm4, digits=10, statistics = "all")

```

```{r plot best count model, echo=FALSE}
plot_model(count_qplm2, type = "pred")
```

in the total count model multicollinearity forces us to use GDP_PPS and drop the sci sci-tech variables. Adding R&D or online purchases does not make the model much better and it is not significant in the quasipoisson models.


## Comparing the Three Models

If we compare the three models (per capita, per researcher, and absolute download counts, all modeled as quasipoisson), we find that consistent results: gross domestic income, researcher employment has a positive effect, internet proficiency has a negative effect. In the model per researcher model we see that higher R&D expenditure can lower download counts. 

```{r 3bestmodels, echo=FALSE}
jtools::export_summs(percapita_qplm3, 
                     perresearcher_qplm1, 
                     count_qplm2, 
                     model.names=
                       c('percapita', 'perresearcher','count'),
                     digits=10, 
                     statistics = "all")
```


To check the robustness of these models, we  also did simple linear regression for all 3 dependent variables. They do not yield different results from the quasipoisson models, but their error terms are much uglier.

Regions with higher gdp and higher researcher share in the workforce download more, while higher online proficiency lowers download numbers, probably due to the positive effects of e-commerce, and the negative effects of better hiding.

## interaction models

Finally, we check the interaction of  wealth (GDP_PPS) and researcher employment with a simple interaction model. 

### simple count variable, GDP and researcher share

```{r interactions, out.width='90%'}
interaction_qplm1<- glm (count  ~ gdp_pps * researcher_employment_pct,
                         data = eurostat_complete_data, 
                         family = quasipoisson )

summary (interaction_qplm1)
plot_model(interaction_qplm1, 
           type = "eff", terms=c("researcher_employment_pct[0.1,1.9]",
                                 "gdp_pps [10000,150000]"))
```

A simple interaction at the count model shows that in richer regions download more even if they have a the same share of researchers as poorer regions, and the count grows faster as the share grows.
This confirms our original hypothesis.

```{r other interactions}
#per capita model does not yield meaningful interaction. only researcher share significant 
interaction_qplm2 <- glm (count_per_million  ~ 
                           gdp_pps * researcher_employment_pct,
                         data = eurostat_complete_data, 
                         family = quasipoisson )
summary (interaction_qplm2)
#per researcher models yield little.  gdp is not relevant
interaction_qplm3 <- glm (count_per_thousand_researchers ~
                            gdp_pps * internet_use_banking_pc,
                          data = eurostat_complete_data, 
                          family = quasipoisson )

summary (interaction_qplm3)
```
Other interaction models with per capita and per researcher dependent variables, and wealth and researcher employment and online proficiency do not yield significant results. 

# Inductive models

We took a first look at this data with two methods. First, we created all possible linear regression equations and two-variable multiple linear regression between the count data and the socio-economic variables. We also used the random forest algorithm to rank the importance of socio-economic environmental variables in explaining the difference in the level of book piracy. The logic of the two approaches is similar. We use a well-defined searching algorithm to find a relationship between the levels of socio-economic environmental variables and download count numbers.
We did the inductive approach twice: first on the larger, but narrower dataset used so far, and second for a smaller dataset which includes new variables from the EUROBAROMETER dataset.

## Linear regression models

To understand the interaction of environmental variables and count data, we created all possible linear regressions 'explaining' the variability of count per capita data in the following steps:

- We created the initial linear regression
- We checked for outliers, and removed them
- Re-run the regression model, and selected those whose coefficients were significant on 1.96 level
- We ordered the remaining 38 models by adjusted R squares.

The following table shows the results of this approach for the smaller, dataset with additional Eurobarometer variables. We get very results consistent with these, if we run the analysis on the larger dataset.

```{r linregsummary, out.width='90%', message=FALSE, echo=FALSE}
# To re-run the many models with the same dataset as used here.
#uncomment the next line if you want to rerun the lingreg models
#source ( 'helper_code/all_linreg_model_combinations.R')
coefficients <- readRDS(
  file.path('data','all_linreg_coefficients_count_per_thousand_researchers.rds') )

#display coefficients
knitr::kable(coefficients[order(-coefficients$r.squared),])

#strange, because ighly correlatedvariables seem to be in the top models. lets do a manual check
test<-lm ('count_per_thousand_researchers ~ internet_use_banking_pc + internet_use_daily_pc', data=eurostat_eurobarometer_complete_data)

summary(test)$coefficients

```

This approach shows results which are consistent with the deductive models.  Wealth, the percentage of knowledge workers in the workforce has positive effects, online proficiency (in all forms) has a negative effect. What is new are the emergence of tow of the new EUROBAROMETER variables: the share of population who visited a public library at least once in the last 12 months (with a negative sign), and the percentage of students in he population (with a positive one).

It is equally informative that neither the open science attitudinal variable (weighted sum of yes answer options to the QD 17 Do you think that the results of publicly funded research should be made available online free of charge?), nor the library inadequacy variable (a weighted sum of the responses that chose from the question block QB2 why you haven’t Visited a public library  or haven’t done it more often in the last 12 months? ... answered with the  option: Limited or poor quality of this activity in the place where you live.) emerged as significant variables. We should note, that in this latter  case, the number of respondents is rather low and this is not a very reliable statistic on regional level.

## Random forest models

In the following we created three sets of analysis: one that uses count per researcher as the dependent variable, One that uses download per capita as download variable, and one that uses raw count as a dependent variable.

The reason for that is that if i use dl/researcher variable as dependent, I may not be able to capture and explain the downloads that possibly come from non-researchers, while if I use dl/capita, then i may find independent variables that account for the professional (researcher downloads) and others that are more characteristic for no-professionals.
In the next step we scaled the variables to unit variance, so that they have equal weight in the variable selection process.

## count per capita (without eurobarometer)

```{r var_select, eval=TRUE, message=FALSE, echo=FALSE}
#count per capita
cpc_var_select_df <- eurostat_complete_scaled %>% 
  dplyr::select ( -researchers_total, 
                  -population_total,
                  -count_per_million,
                  -count_per_thousand_researchers,
                  -one_of(c("area_land_filled", "count", 
                            "count_per_area", 
                            "count_per_researcher",
                            "count_per_pop_density"))) 

## Tuning this model
set.seed(2019) # for reproducability, the random number seed 2019 is used.
cpc_best_mtry_var_select <- tuneRF(dplyr::select ( cpc_var_select_df, 
                                     -geo,
                                     -count_per_capita),
                   as.vector(cpc_var_select_df$count_per_capita), 
                   mtyStart = 1, 
                   stepFactor=1,
                   improve=1e-5, ntree=500, 
                   plot = FALSE, trace = FALSE) #do not plot results...
cpc_var_select.rf <- randomForest(count_per_capita ~ . ,
                            dplyr::select ( cpc_var_select_df, 
                                     -geo ),
                            mtry = as.numeric(cpc_best_mtry_var_select[1]),
                            ntree=5000 )
```

``` {r randomforest_results, echo=FALSE}
cpc_var_select.rf$importance  %>%
  as.data.frame() %>%
  rownames_to_column(., var = "variable") %>%
  set_names ( ., c("variable", "IncNodePurity")) %>%
  arrange ( -IncNodePurity)
```

Educational attainment, disposable income may be relevant for the whole population, beyond just researchers.

```{r feature_importance, out.width='90%', out.width='90%', eval=FALSE}

#count per capita
cpc_predictor_var_select = Predictor$new(
  cpc_var_select.rf,
  data = dplyr::select ( cpc_var_select_df , -geo, - count_per_capita),
  y = as.numeric(cpc_var_select_df$count_per_capita))

cpc_imp <- FeatureImp$new(cpc_predictor_var_select, loss = "mae", n.repetitions = 10)
plot(cpc_imp)
```

```{r display cpc importance plot, echo=FALSE}
knitr::include_graphics('images_graphs/000001.png')
```


```{r percapita_interaction, out.width='90%', eval=TRUE}
#This code takes several minutes to run if uncommented.
run_in_function <- function() {
  interact <- Interaction$new(predictor_var_select)
  plot(interact) #causes knitr issues, something is wrong with the plot, maybe the size, I saved it and print int from file.

}
#run_in_function()
#I saved the result here:
knitr::include_graphics('images_graphs/percapita_interactions_0416.png')
```

# Eurobarometer variables 

## Correlations

```{r perresearcher correlations_eurobarometer, echo=FALSE}
#first lets see how in the best model data anbd correlations look like

cpr_panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y)
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt)
}

cpr_correlations_bestmodel <- eurostat_eurobarometer_complete_data %>%
  dplyr::select (count_per_capita, 
                 internet_use_banking_pc,
                 disposable_income,
                 edu_attainment_total,
                 gdp_pps_hab, 
                 gerd,
                 eb_is_visit_public_library,
                 eb_is_read_book,
                 eb_limited_library_supply,
                 eb_supports_open_access_science,
                 eb_is_student
                 ) %>%
  as.matrix() %>%
  pairs( lower.panel = panel.smooth,
        upper.panel = panel.cor,
      gap=0, row1attop=FALSE, 
      main="Correlation coefficients on the upper panels, scatter plots in the lower panels with LOESS smooths")
```

```{r correlationeb, echo=FALSE }
library(ggplot2)
correlations_eb <- eurostat_eurobarometer_complete_data %>%
  dplyr::select( -starts_with("count_")) %>%
  dplyr::select ( -geo ) %>% 
  as.matrix() %>%
  cor() 

correlations_eb_df <- data.frame ( 
  variable = row.names(correlations_eb), 
  cor = as.numeric(correlations_eb [, "count"])) %>%
  dplyr::filter ( ! grepl( "count", variable )) %>% 
  dplyr::mutate ( variable = forcats::fct_reorder(variable, -cor ))


ggplot (correlations_eb_df, 
        aes ( x = variable, 
              y = cor, 
              fill = cor )) +
  geom_col() +
  scale_fill_gradient2( high = "#007CBB", 
                        mid = 'white', 
                        low = "#DB001C", 
                        midpoint = 0) +
  labs ( title = "Correlation with Count Data", 
         fill = 'Correlation', y = "", x = "") +
  theme (
    axis.text.x = element_text (angle = 30, hjust = 1, size = rel(0.85))
  )
```


Let's start first with the random forest variable selection process. 

## Count per capita - with eurobarometer

```{r var_select_eurobarometer, eval=TRUE, message=FALSE, echo=FALSE}
#count per capita
cpc_var_select_eb_df <- eurostat_eurobarometer_complete_scaled %>% 
  dplyr::select ( -researchers_total, 
                  -population_total,
                  -count_per_million,
                  -count_per_thousand_researchers,
                  -one_of(c("area_land_filled", "count", 
                            "count_per_area", 
                            "count_per_researcher",
                            "count_per_pop_density"))) 


## Tuning this model
set.seed(2019) # for reproducability, the random number seed 2019 is used.
cpc_best_mtry_eb_var_select <- tuneRF(
  dplyr::select ( cpc_var_select_eb_df, 
                  -geo, -count_per_capita),
                   as.vector(cpc_var_select_eb_df$count_per_capita), 
                   mtyStart = 1, 
                   stepFactor=1,
                   improve=1e-5, ntree=500, 
                   plot = FALSE, trace = FALSE) #do not plot results...
cpc_var_select_eb.rf <- randomForest(count_per_capita ~ . ,
                            dplyr::select ( cpc_var_select_eb_df, 
                                     -geo ),
                            mtry = as.numeric(cpc_best_mtry_eb_var_select[1]),
                            ntree=5000 )
```

The Eurobarometer variables, while not as important as the 'hard' environmental variables, are more important than the general internet use variables (derived from other surveys by Eurostat.)

``` {r randomforest_results_eurobarometer, echo=FALSE, results='asis'}

cpc_var_select_eb.rf$importance  %>%
  as.data.frame() %>%
  arrange ( -IncNodePurity)
```

Educational attainment, disposable income may be relevant for the whole population, beyond just researchers.

```{r feature_importance_eurobarometer, out.width='90%', out.width='90%', eval=FALSE}

#count per capita
cpc_predictor_eb_var_select = Predictor$new(
  cpc_var_select_eb.rf,
  data = dplyr::select ( cpc_var_select_eb_df,
                         -geo, - count_per_capita),
  y = as.numeric(cpc_var_select_eb_df$count_per_capita))

cpc_imp_eb_count_per_capita <- FeatureImp$new(
                          cpc_predictor_eb_var_select, 
                          loss = "mae", 
                          n.repetitions = 100)
plot(cpc_imp_eb_count_per_capita)
```

## Count per researcher - with eurobarometer

Here we model the `count_per_researcher` download counts as dependent variables. Library visits from the environment are becoming even more important.

```{r perresearcer_var_select_results_eurobarometer, eval=TRUE, echo=FALSE}
# random forest count per researcher  

cpr_var_select_eb_df <- eurostat_eurobarometer_complete_scaled %>% 
  dplyr::select ( -researchers_total, 
                  -population_total,
                  -count_per_million,
                  -count_per_capita,
                  -count_per_thousand_researchers,
                  -researcher_employment_pct,
                  -one_of(c("area_land_filled", "count", 
                            "count_per_area", 
                            "count_per_pop_density"))) 


cpr_var_select_eb_researcher.rf <- randomForest(
  count_per_researcher ~ . ,
  dplyr::select ( cpr_var_select_eb_df,  -geo ),
  mtry = as.numeric(cpc_best_mtry_var_select[1]),
                            ntree=5000 )

importance <- cpr_var_select_eb_researcher.rf$importance 

data.frame( 
  variable = row.names(importance), 
  importance = as.numeric(importance)
  ) %>%
  arrange ( -importance ) %>%
  knitr::kable()
```



```{r perresearcher_var_select_results_eurobarometer, eval=FALSE, echo=FALSE}
#count per researcher 


cpr_predictor_var_select_count_per_researcher = Predictor$new(
  cpr_var_select_eb_researcher.rf,
  data = dplyr::select ( cpr_var_select_eb_df , -geo, 
                         -count_per_researcher),
  y = as.numeric(cpr_var_select_eb_df$count_per_researcher))


cpr_imp_count_per_researcher <- FeatureImp$new(
  cpr_predictor_var_select_count_per_researcher,
  loss = "mae",
  n.repetitions = 10)

plot(cpr_imp_count_per_researcher)
```

```{r perresearcher_interaction,out.width='90%', eval=TRUE, echo=FALSE}
#This code takes several minutes to run if uncommented.
#cpr_interact <- Interaction$new(cpr_predictor_var_select)
#plot(cpr_interact) #causes knitr issues, something is wrong with the plot, maybe the size, I saved it and print int from file.

```

## Linear Regression with EUROBAROMETER

Since the random forest indicated that the EUROBAROMETER variables might be relevant, we tried to enrich our earlier, simplest models with them.  

The EUROBAROMETER internet access variable is similarly correlated to the EUROSTAT access variable. It is calculated from a different survey, and with slightly different weighting, but the effect is the same. Supporting open access to scientific results is positively correlated with the count data, and perceived low quality of public library supply is negatively correlated.

```{r eurobarometer qpoission}
percapita_qplm3_1 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                           eb_is_visit_public_library,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)
percapita_qplm3_1b <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                           eb_is_visit_public_library+
                            internet_use_banking_pc,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

percapita_qplm3_2 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                          eb_is_read_book,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

percapita_qplm3_3 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                          eb_is_student,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

percapita_qplm3_4 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                          eb_limited_library_supply,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

percapita_qplm3_5 <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                          eb_supports_open_access_science,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

percapita_qplm3_1b <- glm (count_per_million ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                           eb_is_visit_public_library+
                            internet_use_banking_pc,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)


export_summs(percapita_qplm3_1, 
             percapita_qplm3_1b,
             percapita_qplm3_2, 
             percapita_qplm3_3, 
             percapita_qplm3_4,
             percapita_qplm3_5,
             percapita_qplm3_1b,
             digits=3, 
             statistics = c("null.deviance", "deviance")
             )
```
In the per capita download models only the library visit variable is found to be significant, with a negative sign, suggesting that library users download less. This effect, however is only present without the online proficiency variable. If we add that to the model, both lose significance, hinting at the possibility that the two variables describe a similar, latent phonemon.  

## per researcher and raw count models
```{r eurobarometer count regressions}
perresearcher_qplm3_1 <- glm (count_per_thousand_researchers ~ 
                          log(gdp_pps) +
                          eb_is_read_book,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

perresearcher_qplm3_2 <- glm (count_per_thousand_researchers ~ 
                          log(gdp_pps) +
                          eb_is_student,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)
perresearcher_qplm3_3 <- glm (count_per_thousand_researchers ~ 
                          log(gdp_pps) +
                          eb_is_visit_public_library,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)
perresearcher_qplm3_4 <- glm (count_per_thousand_researchers ~ 
                          log(gdp_pps) +
                          eb_limited_library_supply,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)
perresearcher_qplm3_5 <- glm (count_per_thousand_researchers ~ 
                          log(gdp_pps) +
                          eb_supports_open_access_science,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

perresearcher_qplm3_1b <- glm (count_per_thousand_researchers ~ 
                              log(gdp_pps)  + log(disposable_income) + 
                              edu_attainment_total + gerd +
                              internet_use_banking_pc,
                            data = eurostat_eurobarometer_complete_data, 
                            family = quasipoisson )

perresearcher_qplm3_1c <- glm (count_per_thousand_researchers ~ 
                              log(gdp_pps)  + log(disposable_income) + 
                              edu_attainment_total + gerd +
                          internet_use_banking_pc +
                            eb_is_read_book,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

export_summs(perresearcher_qplm3_1,
             perresearcher_qplm3_1b,
             perresearcher_qplm3_1c,
             perresearcher_qplm3_2, 
             perresearcher_qplm3_3, 
             perresearcher_qplm3_4,
             perresearcher_qplm3_5,
             digits=3, 
             statistics = c("null.deviance", "deviance")
             )


```

With the per researcher model we found interesting results which point to the infrastructural effect of shadow library usage: lower  per reserahcer download counts are associated with higher library use, and betterlibrary supply. These findings, however should be treated with caution. The effect of GDP is not significant, and if we add the variables revevant in other models, this effect disappears. 




```{r raw count eurobarometer models}

rawcount_qplm3_1 <- glm (count ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                        eb_is_visit_public_library,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)

rawcount_qplm3_2 <- glm (count ~ 
                          log(gdp_pps) +
                          researcher_employment_pct +
                        eb_limited_library_supply,
                        data = eurostat_eurobarometer_complete_data,
                        family = quasipoisson)
summary(rawcount_qplm3_2)
```
## COarison of the UROBAROMETE models

```{r eurobaromoeter model comparison}
export_summs(percapita_qplm3_1, 
             perresearcher_qplm3_3, 
             perresearcher_qplm3_4,
             digits=3, 
             statistics = c("null.deviance", "deviance"),
             model.names = c("Model 1:DV:count per capita","Model 2a (DV:count per researcher)","Model 2b (DV:count per researcher)")
             )

```


# Other - simple random models, just for the sake of doing it

Here are the results of the per capita, per researchers, and raw count simple linear models.

``` {r raw linreg models}

percapita_lm <- lm (count_per_million ~ gdp_pps +
                      researcher_employment_pct +
                      disposable_income +
                      edu_attainment_total +
                      internet_use_banking_pc,
                    data = eurostat_complete_data)

perresearcher_lm <- lm (count_per_thousand_researchers ~ 
                          gdp_pps  + disposable_income +
                          edu_attainment_total +
                          internet_use_banking_pc,
                        data = eurostat_complete_data)

count_lm <- lm (count ~ gdp_pps +  
                    researcher_employment_pct +
                    disposable_income +
                    edu_attainment_total +
                    internet_use_banking_pc +
                    gerd+internet_purchases_last_year_pc,
                data = eurostat_complete_data)
vif(count_lm)

export_summs(percapita_lm,perresearcher_lm,count_lm, 
             digits=10, statistics = "all",
             model.names=c('percapita', 'perresearcher','count')
             )

plot(count_lm)
```

The standard linear model for the count variable shows the same as the Poisson and quasipoisson models:

- downloads grow with wealth, researcher share, and disposable income, but are moderated by online proficiency and R&D investment.

- online purchases are not significant, neither is the level of education.
the model fit is comparable to the quasipoisson model fits.

we also have to note that linear models behave extremely bad in high count regions, worse than quasipoisson models.

```{r raw count linref plot}
plot(count_lm)
```

